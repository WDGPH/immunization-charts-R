---
output:
  pdf_document:
    latex_engine: pdflatex
    keep_tex: false
documentclass: article
header-includes:
  - \usepackage{amssymb}
  - \usepackage{graphicx}
  - \usepackage{multicol}
  - \usepackage{parskip}
  - \usepackage[margin=2cm, top=1cm]{geometry}
  - \usepackage{ragged2e} # text alignment utilities
  - \usepackage{ltablex}  # tabularx with longtable functionality
  - \usepackage{rotating} # rotating table cells
  - \usepackage{refcount}
  - \usepackage{fancyhdr} # custom page numbering
  - \usepackage{afterpage} # For adding a blank page
  - \usepackage{lastpage}
  - \usepackage{etoolbox} # for creating toggles
  - \usepackage{calc} # widthof function for redact
  - \usepackage{enumitem} # for custom list types
  - \usepackage{soul} # for better underline
  - \usepackage{xcolor} # for custom colours
  - \usepackage[scaled]{helvet} # use Helvetica (Arial-like)
  - \renewcommand{\familydefault}{\sfdefault} # make Helvetica the default font
  - \newcounter{letter} # Counter for letters
  - \usepackage{needspace}
params:
  client_data: NULL
  chart_num_diseases: NULL
  chart_col_header: NULL
  data_date: NULL
---

```{=latex}
% Redaction functionality
\newtoggle{toggle_redact}
% \toggletrue{toggle_redact} % Enable redaction
\togglefalse{toggle_redact} % Disable redaction
\newcommand{\redact}[1]{\iftoggle{toggle_redact}{\rule[-0.3em]{\widthof{#1}}{1em}}{#1}}

% Page number verification functionality
\newtoggle{toggle_checkpagecount} % Define a new toggle
\toggletrue{toggle_checkpagecount} % Enable page check
% \togglefalse{toggle_checkpagecount} % Disable the page check

\newcounter{startpage}
\newcounter{endpage}
\newcounter{lettertotalpages}

% Custom bold list environment
\newlist{bolditemize}{itemize}{1}
\setlist[bolditemize,1]{before=\bfseries, label=$\bullet$}

% Custom circle indicator for vaccination history charts
\newcommand{\mycircle}{\raisebox{-0.2\height}{\resizebox{1em}{!}{$\bullet$}}}

% Custom colours
\definecolor{darkred}{RGB}{153, 0, 0}
\definecolor{wdgteal}{HTML}{005568}

% link-like formatting
\newcommand{\myurl}[1]{\mbox{\textbf{\textcolor{wdgteal}{\setul{0.5ex}{0.2ex}\setulcolor{wdgteal}\ul{#1}}}}}

% Remove the horizontal lines when using fancyhdr
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% Define a command to reset page counter and set up the page style for each letter
\newcommand{\newdocument}{%
  \stepcounter{letter}%
  \setcounter{page}{1}% Reset the page counter for each letter
  \label{startpage\theletter}% Record the starting page number
  \pagestyle{fancy}%
  \fancyhf{}%
  % Footer content
  \fancyfoot[C]{
  \centering
  Page \thepage\ of \pageref{LastPage\theletter}
  }
}

\newcommand{\checkpagecount}[1]{%
  \iftoggle{toggle_checkpagecount}{%
    \setcounter{startpage}{\getpagerefnumber{startpage\theletter}}%
    \setcounter{endpage}{\getpagerefnumber{endpage\theletter}}%
    \setcounter{lettertotalpages}{\value{endpage} - \value{startpage} + 1}%
    \ifnum\value{lettertotalpages}=#1%
      % Page count is as expected; do nothing
    \else
      \PackageWarning{mypackage}{%
        Letter \number\value{letter} starting on page \number\value{startpage}: Physical page count is \number\value{lettertotalpages} but expected #1 pages%
      }%
    \fi
  }{}
}

% Calculated lengths
\newlength{\schooltextwidth}
\settowidth{\schooltextwidth}{School: }
```

```{r, results='asis', echo=FALSE}
# One client per row
for (j in seq_len(nrow(params$client_data))) {
  # Extract single row of data
  client = as.list(params$client_data[j,])

  client$`Page LaTeX` = c(
"
\\newdocument

\\begin{center}
{\\Large \\textbf{Bring this notice to your family doctor or healthcare provider}}
\\end{center}

\\vspace{0.5cm}

\\begin{minipage}[c]{0.35\\textwidth}
  \\includegraphics[width=6cm]{assets/logo.pdf}
\\end{minipage}
\\hfill
\\begin{minipage}[c]{0.60\\textwidth}
  \\raggedleft \\huge \\textbf{Request for Immunization Records}
\\end{minipage}

\\vspace{0.25cm}

\\setlength{\\arrayrulewidth}{1.5pt}
\\renewcommand{\\arraystretch}{2}
\\setlength{\\tabcolsep}{10pt}
\\begin{table}[h!]
    \\begin{tabularx}{\\textwidth}{|X|X|}
    \\hline
    To the parent/guardian of:
        \\newline\\redact{\\textbf{", client$Name, "}}
        \\newline\\newline
        \\begin{minipage}[t]{\\linewidth}\\raggedright
            \\textbf{\\redact{", if(!is.na(client$`Street Address`)) {paste0(client$`Street Address`, collapse = "")}, "}",
            if(!is.na(client$`City`)) {paste0("\\newline ", client$`City`, ", ", client$`Province`, collapse = "")},
            if(!is.na(client$`Postal Code`)) {paste0(" ", client$`Postal Code`, collapse = "")},
        "}\\end{minipage}\\newline
    &
        Client ID: \\textbf{", client$`Client ID`, "}\\newline
        Ontario Immunization ID: \\textbf{", client$`Ontario Immunization ID`, "}\\newline
        Date of Birth: \\redact{\\textbf{", client$`Date of Birth`, "}}\\newline\\newline
        Facility: \\begin{minipage}[t]{\\dimexpr\\linewidth-\\schooltextwidth}\\raggedright
            \\textbf{", client$`School`, "}
        \\end{minipage}\\newline
    \\\\
    \\hline
\\end{tabularx}
\\end{table}

\\normalsize\\justifying
As of \\textbf{", params$data_date, "}, Wellington-Dufferin-Guelph (WDG) Public Health does not have up-to-date vaccination records for your child, \\redact{\\textbf{", client$Name, "}}. Please review the immunization record included in this notice, and update your child's record using one of the following options: and report any vaccines received to WDG Public Health.

\\vspace{0.25cm}
\\begin{itemize}
\\setlength\\itemsep{-0.5em}
  \\item By visting \\myurl{www.immunizewdg.ca}
  \\item By emailing \\myurl{vaccine.records@wdgpublichealth.ca}
  \\item By mailing a photocopy of child's immunization record to: Vaccine Records, 160 Chancellors Way, Guelph, ON N1G 0E1
  \\item By Phone: 1-800-265-7293 ext. 7006
\\end{itemize}
\\vspace{0.25cm}

\\normalsize\\justifying
Please update Public Health and your childcare centre everytime your child receives a vaccine. By keeping your child's vaccinations up to date, you are not only protecting their health but also the health of other children and staff at the childcare centre.

\\normalsize\\justifying
\\textbf{If you are choosing not to immunize your child}, a valid medical exemption or statement of conscience or religious belief must be completed and submitted to Public Health. Links to these forms can be located at \\myurl{https://wdgpublichealth.ca/your-kids/vaccination}. Please note this exemption is for childcare only, and a new exemption will be required upon enrollment in elementary school.

\\normalsize\\justifying
If there is an outbreak of a vaccine-preventable disease, Public Health may require that children who are not adequately immunized (including those with exemptions) be excluded from the childcare centre until the outbreak is over.

\\normalsize\\justifying
If you have any questions about your child's vaccines, please call 1-800-265-7293 ext. 7006 to speak with a Public Health Nurse.

\\vspace{0.5cm}

Sincerely,

\\includegraphics[width=6cm]{assets/signature2.jpg}

\\textbf{Dr. Matthew Tenenbaum, MD, CCFP, MPH, FRCPC}\\newline
Associate Medical Officer of Health\\newline
Wellington-Dufferin-Guelph Public Health

\\vspace{0.5cm}

\\begin{center}
{\\Large \\textbf{Every time your child gets a vaccine, please update their immunization record with Public Health. For more information visit \\myurl{www.immunizewdg.ca} }}
\\end{center}

\\clearpage

\\begin{FlushRight}
\\normalsize Client ID: \\textbf{", client$`Client ID`, "}
\\end{FlushRight}

\\vspace{0.5cm}

\\setlength{\\arrayrulewidth}{1pt}
\\renewcommand{\\arraystretch}{1.25}
\\setlength{\\tabcolsep}{1pt}
\\keepXColumns
\\begin{tabularx}{\\textwidth}{|l|l", rep("|>{\\centering\\arraybackslash}p{0.35cm}", params$chart_num_diseases + 1L), "|>{\\raggedright\\arraybackslash}X|}
\\hline
", params$chart_col_header, "\\\\
\\hline
\\endfirsthead

\\multicolumn{", params$chart_num_diseases + 4L, "}{c}{{Continuation of immunization record}} \\\\
\\hline
", params$chart_col_header, "\\\\
\\hline
\\endhead

\\multicolumn{", params$chart_num_diseases + 4L, "}{c}{{Immunization record continued on next page}}
\\endfoot
",
"\\multicolumn{", params$chart_num_diseases + 4L, "}{c}{{End of immunization record}}
\\endlastfoot
",
client$`Vaccine History LaTeX`[[1]],
"
\\end{tabularx}
\\needspace{2cm}
\\null
\\vspace*{\\fill}
\\begin{justify}
{\\footnotesize
The information in this notice was collected under the authority of the \\textit{Health Protection and Promotion Act} in accordance with the \\textit{Municipal Freedom of Information and Protection of Privacy Act} and the \\textit{Personal Health Information Protection Act}. This information is used for the delivery of public health programs and services; the administration of the agency; and the maintenance of healthcare databases, registries and related research, in compliance with legal and regulatory requirements. Any questions about the management of this information should be addressed to the Chief Privacy Officer at 1-800-265-7293 ext. 2975 or privacy@wdgpublichealth.ca.}
\\end{justify}

\\label{LastPage\\theletter}

\\ifnum\\value{page}=1
  \\newpage
  \\thispagestyle{empty}
  \\null
\\fi

\\label{endpage\\theletter}

\\checkpagecount{2}

\\clearpage")
    
  cat(client$`Page LaTeX`, sep = "")
  }
```
