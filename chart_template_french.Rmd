---
output:
  pdf_document:
    latex_engine: xelatex
    keep_tex: false
documentclass: article
header-includes:
  - \usepackage{amssymb}
  - \usepackage{graphicx}
  - \usepackage{multicol}
  - \usepackage{parskip}
  - \usepackage[margin=2cm, top=1cm]{geometry}
  - \usepackage{ragged2e} # text alignment utilities
  - \usepackage{ltablex}  # tabularx with longtable functionality
  - \usepackage{rotating} # rotating table cells
  - \usepackage{refcount}
  - \usepackage{fancyhdr} # custom page numbering
  - \usepackage{afterpage} # For adding a blank page
  - \usepackage{lastpage}
  - \usepackage{fontspec} # font utilities
  - \usepackage{etoolbox} # for creating toggles
  - \usepackage{calc} # widthof function for redact
  - \usepackage{enumitem} # for custom list types
  - \usepackage{soul} # for better underline
  - \setmainfont{Arial} # default font type 
  - \usepackage{xcolor} # for custom colours
  - \newcounter{letter} # Counter for letters
  - \usepackage{needspace}
params:
  client_data: NULL
  chart_num_diseases: NULL
  chart_col_header: NULL
  data_date: NULL
---

```{=latex}
% Redaction functionality
\newtoggle{toggle_redact}
% \toggletrue{toggle_redact} % Enable redaction
\togglefalse{toggle_redact} % Disable redaction
\newcommand{\redact}[1]{\iftoggle{toggle_redact}{\rule[-0.3em]{\widthof{#1}}{1em}}{#1}}

% Page number verification functionality
\newtoggle{toggle_checkpagecount} % Define a new toggle
\toggletrue{toggle_checkpagecount} % Enable page check
% \togglefalse{toggle_checkpagecount} % Disable the page check

\newcounter{startpage}
\newcounter{endpage}
\newcounter{lettertotalpages}

% Custom bold list environment
\newlist{bolditemize}{itemize}{1}
\setlist[bolditemize,1]{before=\bfseries, label=$\bullet$}

% Custom circle indicator for vaccination history charts
\newcommand{\mycircle}{\raisebox{-0.2\height}{\resizebox{1em}{!}{$\bullet$}}}

% Custom colours
\definecolor{darkred}{RGB}{153, 0, 0}
\definecolor{wdgteal}{HTML}{005568}

% link-like formatting
\newcommand{\myurl}[1]{\mbox{\textbf{\textcolor{wdgteal}{\setul{0.5ex}{0.2ex}\setulcolor{wdgteal}\ul{#1}}}}}

% Remove the horizontal lines when using fancyhdr
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

% Define a command to reset page counter and set up the page style for each letter
\newcommand{\newdocument}{%
  \stepcounter{letter}%
  \setcounter{page}{1}% Reset the page counter for each letter
  \label{startpage\theletter}% Record the starting page number
  \pagestyle{fancy}%
  \fancyhf{}%
  % Footer content
  \fancyfoot[C]{
  \centering
  Page \thepage\ sur \pageref{LastPage\theletter}
  }
}

\newcommand{\checkpagecount}[1]{%
  \iftoggle{toggle_checkpagecount}{%
    \setcounter{startpage}{\getpagerefnumber{startpage\theletter}}%
    \setcounter{endpage}{\getpagerefnumber{endpage\theletter}}%
    \setcounter{lettertotalpages}{\value{endpage} - \value{startpage} + 1}%
    \ifnum\value{lettertotalpages}=#1%
      % Page count is as expected; do nothing
    \else
      \PackageWarning{mypackage}{%
        Letter \number\value{letter} starting on page \number\value{startpage}: Physical page count is \number\value{lettertotalpages} but expected #1 pages%
      }%
    \fi
  }{}
}

% Calculated lengths
\newlength{\schooltextwidth}
\settowidth{\schooltextwidth}{School: }
```

```{r, results='asis', echo=FALSE}
# One client per row
for (j in seq_len(nrow(params$client_data))) {
  # Extract single row of data
  client = as.list(params$client_data[j,])

  client$`Page LaTeX` = c(
"
\\newdocument

\\begin{center}
{\\color{darkred}\\large \\textbf{Apportez cet avis à votre médecin de famille ou à votre fournisseur de soins de santé}}
\\end{center}

\\vspace{0.5cm}

\\begin{minipage}[c]{0.35\\textwidth}
  \\includegraphics[width=6cm]{assets/logo.eps}
\\end{minipage}
\\hfill
\\begin{minipage}[c]{0.60\\textwidth}
  \\raggedleft \\huge \\textbf{Avis d’immunisation}
\\end{minipage}

\\vspace{0.25cm}

\\setlength{\\arrayrulewidth}{1.5pt}
\\renewcommand{\\arraystretch}{2}
\\setlength{\\tabcolsep}{10pt}
\\begin{table}[h!]
    \\begin{tabularx}{\\textwidth}{|X|X|}
    \\hline
        Élève:
        \\newline\\redact{\\textbf{", client$Name, "}}
        \\newline\\newline
        \\begin{minipage}[t]{\\linewidth}\\raggedright
            \\textbf{\\redact{", if(!is.na(client$`Street Address`)) {paste0(client$`Street Address`, collapse = "")}, "}",
            if(!is.na(client$`City`)) {paste0("\\newline ", client$`City`, ", ", client$`Province`, collapse = "")},
            if(!is.na(client$`Postal Code`)) {paste0(" ", client$`Postal Code`, collapse = "")},
        "}\\end{minipage}\\newline
    &
        No d’identification du client: \\textbf{", client$`Client ID`, "}\\newline\\newline
        Date de naissance: \\redact{\\textbf{", client$`Date of Birth`, "}}\\newline\\newline
        École: \\begin{minipage}[t]{\\dimexpr\\linewidth-\\schooltextwidth}\\raggedright
            \\textbf{", client$`School`, "}
        \\end{minipage}\\newline
    \\\\
    \\hline
\\end{tabularx}
\\end{table}

\\normalsize\\raggedright
À partir du \\textbf{", params$data_date, "}, nos dossiers montrent que/qu’ \\redact{\\textbf{", client$Name, "}} n’a pas reçu le ou les vaccins suivants:

\\vspace{0.25cm}
\\begin{bolditemize}
\\setlength\\itemsep{-0.5em}
  \\item ", client$`Vaccines Due`, "
\\end{bolditemize}
\\vspace{0.25cm}

\\normalsize\\raggedright
Il est de la responsabilité du père, de la mère, du tuteur ou de la tutrice de l’élève de mettre à jour ce dossier d’immunisation en éclarant les vaccins reçus au Bureau de santé.

Pour obtenir des renseignements sur les exemptions de vaccination, veuillez consulter le site: \\myurl{https://wdgpublichealth.ca/your-kids/vaccination}.

\\vspace{0.25cm}

\\setlength{\\arrayrulewidth}{1pt}
\\renewcommand{\\arraystretch}{1.25}
\\setlength{\\tabcolsep}{1pt}
\\keepXColumns
\\begin{tabularx}{\\textwidth}{|l|l", rep("|>{\\centering\\arraybackslash}p{0.35cm}", params$chart_num_diseases + 1L), "|>{\\raggedright\\arraybackslash}X|}
\\hline
", params$chart_col_header, "\\\\
\\hline
\\endfirsthead

\\multicolumn{", params$chart_num_diseases + 4L, "}{c}{{Suite du carnet de vaccination}} \\\\
\\hline
", params$chart_col_header, "\\\\
\\hline
\\endhead

\\multicolumn{", params$chart_num_diseases + 4L, "}{c}{{Le carnet de vaccination continue à la page suivante}}
\\endfoot
",
"\\multicolumn{", params$chart_num_diseases + 4L, "}{c}{{Fin du carnet de vaccination}}
\\endlastfoot
",
client$`Vaccine History LaTeX`[[1]],
"
\\end{tabularx}
\\needspace{2cm}
\\null
\\vspace*{\\fill}
\\begin{justify}
{\\footnotesize
Les renseignements recueillis dans cet avis relèvent de la \\textit{Loi sur la protection et la promotion de la santé}, conformément à la \\textit{Loi sur l’accès à l’information municipale et la protection de la vie privée} et à la \\textit{Loi de 2004 sur la protection des renseignements personnels sur la santé}. Ces renseignements sont utilisés dans le cadre de la prestation des programmes et des services de santé publique, de l’administration de l’organisme et de l’entretien des bases de données, des registres et des travaux de recherche connexes liés aux soins de santé, conformément aux exigences juridiques et réglementaires. Pour toute question au sujet de la gestion de ces renseignements, veuillez communiquer avec le chef de la protection des renseignements personnels en composant le 1 800 265 7293, poste  2975 ou en envoyant un courriel à privacy@wdgpublichealth.ca.}
\\end{justify}

\\label{LastPage\\theletter}

\\ifnum\\value{page}=1
  \\newpage
  \\thispagestyle{empty}
  \\null
\\fi

\\label{endpage\\theletter}

\\checkpagecount{2}

\\clearpage")
    
  cat(client$`Page LaTeX`, sep = "")
  }
```
